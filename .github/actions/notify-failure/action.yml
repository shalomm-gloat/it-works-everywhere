name: 'Notify Failure'
description: 'Send failure notifications for deployment'

inputs:
  environment:
    description: 'Environment that failed deployment'
    required: true
  brevo-smtp-user:
    description: 'Brevo SMTP username'
    required: true
  brevo-smtp-key:
    description: 'Brevo SMTP password'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Notify deployment failure
      uses: actions/github-script@v6
      with:
        script: |
          const environment = '${{ inputs.environment }}';
          const environmentName = environment.charAt(0).toUpperCase() + environment.slice(1);
          
          // Create failure notification
          const message = `‚ùå **${environmentName} Deployment Failed**
          
          **Repository**: ${context.repo.owner}/${context.repo.repo}
          **Branch**: ${context.ref_name}
          **Commit**: ${context.sha.substring(0, 7)}
          **Triggered by**: ${context.actor}
          **Workflow**: ${context.workflow}
          **Run ID**: ${context.runId}
          
          üö® Check the logs for details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          // Log notification
          console.log('üö® FAILURE NOTIFICATION:');
          console.log(message);
          
          // Create GitHub issue for failure tracking
          try {
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® ${environmentName} Deployment Failed - ${context.sha.substring(0, 7)}`,
              body: `## ${environmentName} Deployment Failure
            
              **Repository**: ${context.repo.owner}/${context.repo.repo}
              **Branch**: ${context.ref_name}
              **Commit**: ${context.sha}
              **Triggered by**: ${context.actor}
              **Workflow**: ${context.workflow}
              **Run ID**: ${context.runId}
              
              **Logs**: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              ## Next Steps
              - [ ] Investigate failure cause
              - [ ] Fix issues in development
              - [ ] Re-run deployment
              - [ ] Consider rollback if needed`,
              labels: ['deployment-failure', 'urgent', 'ci-cd']
            });
            console.log('‚úÖ Failure issue created');
          } catch (error) {
            console.log('‚ö†Ô∏è Could not create failure issue (this is normal for some permissions)');
            console.log('Error details:', error.message);
          }

    - name: Send failure email notification
      uses: dawidd6/action-send-mail@v6
      with:
        server_address: smtp.gmail.com
        server_port: 587
        secure: false
        username: ${{ inputs.brevo-smtp-user }}
        password: ${{ inputs.brevo-smtp-key }}
        subject: "‚ùå ${{ inputs.environment }} Deployment Failed - ${{ github.repository }}"
        to: ${{ github.event.pusher.email }}
        from: "<shalommeoded@gmail.com>"
        body: |
          Hello ${{ github.actor }},
          
          Your deployment to ${{ inputs.environment }} environment has failed.
          
          **Details:**
          - Repository: ${{ github.repository }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          - Environment: ${{ inputs.environment }}
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          
          **Logs**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          üö® Please check the logs and fix the issues before re-running the deployment.
          
          Best regards,
          CI/CD Pipeline
        convert_markdown: true
